# parameters:
#   restag: name of resalloc tag
- builder:
    name: 'prepare-rhscl-images'
    builders:
        - shell: |
            #!/bin/bash
            set -ex

            repo_name=$(jq -r '.repository.name' <<< "$CI_MESSAGE")
            rconnection="--connection http://10.0.149.99:49100/"

            resalloc $rconnection ticket --tag {restag} > ticket
            ticket=$(cat ticket)
            host=$(resalloc $rconnection ticket-wait "$ticket")

            cat > ssh_config << EOF
            UserKnownHostsFile /dev/null
            StrictHostKeyChecking no
            User root
            ConnectTimeout 10

            Host host
              Hostname ${{host}}
              IdentityFile ~/.ssh/id_rsa_resalloc
            EOF

            # Create script for cleanup
            cat > .cleanup.sh << EOF
            #!/bin/bash
            set -ex

            resalloc $rconnection ticket-close "$ticket"
            if [ -d "./$repo_name" ]; then
              rm -rf "./$repo_name"
            fi
            rm ticket ssh_config
            EOF
            chmod a+x .cleanup.sh

